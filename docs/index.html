<!DOCTYPE html>
<html lang="ja">
<head>
	<title>サイト移転のお知らせ</title>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<script src="https://unpkg.com/dexie@2.0.4/dist/dexie.js"></script>
</head>
<body>
	<style>
		body {
			max-width: 600px;
			margin: 3em auto;
			text-align: center;
		}

		section {
			margin: 3em 0;
		}

		#target {
			display: none;
		}

		#result {
			min-height: 50px;
			padding: 0.5em;
			border: solid 1px black;
			background: #333;
			color: #eee;
			text-align: left;
			font: monospace;
			overflow: auto;
		}
	</style>
	<iframe id="target" src="https://coc.f-sp.com/migration"></iframe>
	<section>
		<h1>クトゥルフTRPG ツール 跡地</h1>
		<p>このサイトは移転しました。</p>
		<p>移転先は下記のURLとなります。</p>
		<p><a href="https://coc.f-sp.com/">https://coc.f-sp.com/</a></p>
		<p>このサイトは三月末頃までに削除予定です。</p>
	</section>
	<section>
		<p>下のボタンにてデータの移行が可能です。</p>
		<p><button id="invoke" type="button">データ移行</button></p>
		<pre id="result"></pre>
	</section>
	<script>
		const TARGET_ORIGIN = "https://coc.f-sp.com";
		const target = document.getElementById("target");
		const button = document.getElementById("invoke");
		const result = document.getElementById("result");

		const db = new Dexie("status");
		db.version(1).stores({
			views: "target",
			characters: "uuid",
			profiles: "uuid",
			attributes: "uuid",
			skills: "uuid",
			items: "uuid",
			histories: "uuid",
		});

		button.addEventListener('click', () => {
			button.disabled = true;

			log("データ移行開始");

			Promise.all([
				db.views.toArray(),
				db.characters.toArray(),
				db.histories.toArray(),
			]).then(([views, characters, histories]) => {
				for (const view of views) log(`view: ${view.target}`);
				for (const character of characters) log(`character: ${character.uuid} (${character.history})`);
				for (const history of histories) log(`history: ${history.uuid}`);

				const json = JSON.stringify({ views, characters, histories });
				return send(target.contentWindow, json, "*");
			}).then(() => {
				log("データの移行が完了しました");
			}).catch(e => {
				log(e.message);
				log("データの移行に失敗しました");
			});
		});

		function send(target, message, origin) {
			return new Promise((resolve, reject) => {
				function callback(event) {
					if (event.origin === TARGET_ORIGIN) {
						window.removeEventListener('message', callback);

						!event.data ? resolve() : reject(new Error(event.data));
					}
				}

				window.addEventListener('message', callback);
				target.postMessage(message, origin);
			});
		}

		function log(text) {
			result.textContent += `${text}\n`;
		}
	</script>
</body>
</html>